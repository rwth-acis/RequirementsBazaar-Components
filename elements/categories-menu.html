<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../iron-ajax/iron-ajax.html">
<link rel="import" href="../../paper-item/paper-item.html">
<link rel="import" href="../../paper-listbox/paper-listbox.html">

<dom-module id="categories-menu">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-item {
        --paper-item: {
          cursor: pointer;
        };
        --paper-item-selected: {
          background-color: #eceff1;
        };
      }

      paper-item:hover {
        --paper-item: {
          cursor: pointer;
          background-color: #eff2f3;
        };
      }


    </style>

    <iron-ajax
      id="categoriesLoader"
      loading="{{loading}}"
      url="[[resourceURL]]"
      headers="[[authHeader]]"
      last-response="{{categories}}"
      params='{"page":"0", "per_page":"150"}'
      auto></iron-ajax>

    <paper-listbox selected="{{categoryId}}" attr-for-selected="value">

      <template is="dom-repeat" items="{{categories}}">
          <paper-item on-click="_selectCategory">[[item.name]]</paper-item>
      </template>

    </paper-listbox>
  </template>

  <script>
      class categoriesMenu extends Polymer.Element{
          static get is() { return 'categories-menu'; }

          static get properties() {
              return {
                  _apiBaseUrl: {
                      type: String,
                      value: 'https://requirements-bazaar.org/bazaar/'
                  },
                  _fileApiBaseUrl: {
                      type: String,
                      value: 'https://requirements-bazaar.org/fileservice/files/'
                  },
                  currentUser: {
                      type: String
                  },
                  /**
                   * Defines whether the user is logged in or not.
                   */
                  authorized: {
                      type: Boolean,
                      value: false
                  },
                  authHeader: {
                      type: Array
                  },
                  authToken: {
                      type: String,
                      observer: '_authTokenChanged'
                  },
                  projectId: {
                      type: Number
                  },
                  resourceURL: {
                      type: String,
                      computed: '_computeResourceURL(projectId)'
                  },
                  categories: {
                      type: Array,
                      notify: true
                  },
                  categoryId: {
                      type: Number,
                      notify: true
                  },
                  view: {
                      type: String,
                      notify: true
                  },
                  /**
                   * Whether any loading operation is currently active.
                   */
                  loading: {
                      type: Boolean,
                      notify: true
                  }
              };
          }

          constructor() {
              super();
          }

          _authTokenChanged(token) {
              this.authorized = true;
              this.authHeader = {authorization: "Bearer " + token};
          }

          _computeResourceURL(projectId) {
              return this._apiBaseUrl + 'projects/' + projectId + '/categories';
          }

          _selectCategory(e){
              this.categoryId = e.model.item.id;
              this.category = e.model.item;
              this.view = 'requirements';
          }

          load() {
              this.shadowRoot.querySelector('#categoriesLoader').generateRequest();
          }
      }
      window.customElements.define(categoriesMenu.is, categoriesMenu);
  </script>

</dom-module>
