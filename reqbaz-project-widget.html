<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-meta/iron-meta.html">
<link rel="import" href="../paper-progress/paper-progress.html">
<link rel="import" href="view-categories.html">

<script src="../moment/moment.js"></script>
<script src="../moment-timezone/moment-timezone.js"></script>

<dom-module id="reqbaz-project-widget">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        --app-primary-color: #447500;
        --primary-color: #447500;
        --app-secondary-color: black;
        --accent-color: #FF5252;

        --spacer-right-drawer: 256px;
        --list-hover-background-color: #d5d5d5;

        --paper-button: {
          color: #157741;
        };
      }

      @media (max-width: 600px) {
        #openidconnectSignin {
          display: none !important;
        }
      }
    </style>

    <iron-ajax
            id="currentUserRequest"
            loading="{{loading}}"
            handle-as="json"
            url="[[_apiBaseUrl]]users/me"
            content-type="application/json"
            method="GET"
            headers="[[authHeader]]"
            on-response="_handleCurrentUserResponse"
            on-error="_handleCurrentUserError"></iron-ajax>
    <iron-ajax
            auto
            id="projectRequest"
               loading="{{loading}}"
               content-type="application/json"
               url="[[_apiBaseUrl]]projects/[[projectId]]"
               headers="[[authHeader]]"
               last-response="{{project}}"></iron-ajax>

    <paper-progress disabled="[[!loading]]" indeterminate style="width: 100%;" hidden="[[!loading]]"></paper-progress>
    <view-categories name="categories" project-id="{{projectId}}" project="{{project}}" view="categories-list" loading="{{loading}}"
                     authorized="{{authorized}}"  auth-token="{{authToken}}" current-user="{{currentUser}}">
    </view-categories>
  </template>

  <script>
    /**
     * `reqbaz-project-widget`
     * Requirements Bazaar widget for a single project with Polymer 2
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class ReqbazProjectWidget extends Polymer.Element {
      static get is() { return 'reqbaz-project-widget'; }

      static get properties() {
        return {
            _apiBaseUrl: {
                type: String,
                value: 'https://requirements-bazaar.org/bazaar/'
            },
            _fileApiBaseUrl: {
                type: String,
                value: 'https://requirements-bazaar.org/fileservice/files/'
            },
            currentUser: {
                type: String
            },
            /**
             * Defines whether the user is logged in or not.
             */
            authorized: {
                type: Boolean,
                value: false
            },
            authHeader: {
                type: Array
            },
            authToken: {
                type: String,
                observer: '_authTokenChanged'
            },
            project: {
                type: Object
            },
            projectId: {
                type: Number,
                notify: true
            },
            loading: {
                type: Boolean,
                value: false
            }
        };
      }
        connectedCallback() {
            // load project
            super.connectedCallback();
            this.shadowRoot.querySelector('#currentUserRequest').generateRequest();
            this.shadowRoot.querySelector('#projectRequest').generateRequest();
        }

        _handleCurrentUserResponse(e, detail) {
            this.currentUser = detail.response;
        }

        _authTokenChanged(token) {
            this.authorized = true;
            this.authHeader = {authorization: "Bearer " + token};
        }

    }

    window.customElements.define(ReqbazProjectWidget.is, ReqbazProjectWidget);
  </script>
</dom-module>
